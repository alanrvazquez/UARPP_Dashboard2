---
title: "Cultivar Data 2019-2023"
author: ""
logo: "images/UARPP-LogoV2.png"
format: 
  dashboard:
    orientation: rows
    theme: custom.scss
server: shiny
---

```{r}
#| context: setup
#| echo: false
#| output: false

# Load libraries.
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggformula)
library(factoextra) # For cluster analysis

################################################################################
# Read data
################################################################################
rice.data = read_excel("data/cultivar_data_2019-2023.xlsx")

################################################################################
# Preprocessing
################################################################################

rice.data = rice.data %>%  mutate_at(c("Year", "Cultivar", "PurelineHybrid", "Grain Size"), as.factor)

select_variables = tbl_vars(rice.data)[c(6:13, 64:68)]
subset_rice.data = rice.data %>% select(all_of(select_variables))

time_variables = c("MRY", "HRY", "SLC", "NIR_ColorL", "NIR_Colora", "NIR_Colorb", "NIR_ProtCont", "HCM_L", "HCM_a", "HCM_b")
var_names = c(tbl_vars(subset_rice.data), time_variables)
 
# Data for clustering

#grouping.data = rice.data %>% filter(Year == 2022) %>% select(c("Cultivar","Peak","Trough", "Breakdown", "Setback", "Final"))
pasting.data = rice.data %>% select(c("Cultivar", "Peak","Trough", "Breakdown", "Setback", "Final")) %>% 
  group_by(Cultivar) %>% 
  summarise_all(mean)

################################################################################
# Plot theme
################################################################################

ytext <- 18
xtext <- ytext
y.axis.title <- 20
x.axis.title <- y.axis.title
legtext <- 18

uarpp_colors <- c("#D9516D", "#C49A6C", "#000000")

plot.theme <- theme_minimal() +
  theme(
    text = element_text(family = "Georgia", color = "#000000"),  # Font and text color
    panel.background = element_rect(fill = "#ffffff"),  # Background color
    plot.background = element_rect(fill = "#ffffff"),
    legend.background = element_rect(fill = "#ffffff"),
    legend.position = "top",
    axis.title = element_text(size = 20, color = "#A0192E", face = "bold"),  # Red axis labels
    axis.text = element_text(size = 18, color = "#000000"),  # Black axis text
    legend.text = element_text(size = 18, color = "#000000"),
    legend.title = element_text(size = 20, color = "#A0192E", face = "bold")
  )


```


# {.sidebar}

```{r}
#| title: Inputs
#selectInput("sampleSize", "Number of subjects:", 
#            unique(summary_results$n))
#radioButtons("year", "Year:", 
#            c("All", "2019", "2020", "2021", "2022", "2023"))

#varSelectInput("variable", "Quality Parameter:", subset_rice.data)
selectInput("variable", "Quality Parameter:", var_names)
sliderInput("k", "Groups:", min = 2, max = 5, value = 3)
```

```{r}
#| context: server
#| echo: false
#| output: false

dataset = reactive({
    if (input$variable %in% time_variables){
        my.data = rice.data %>% select(starts_with(input$variable))
        my.data = my.data %>% rename_with(~str_remove(., paste(input$variable, '_', sep = '')))
        my.data = my.data %>% rename_with(~str_remove(., 's'))
        var_sel = my.data %>%  colnames()
        my.data = my.data %>% mutate("Cultivar" = rice.data$Cultivar)
        my.data = my.data %>% pivot_longer(cols = all_of(var_sel), names_to = "Time", values_to = input$variable)
        my.data = my.data %>% mutate_at("Time", as.numeric)  
    } else {
      my.data = subset_rice.data %>% select(input$variable)    
    }
    
  my.data
})

# Enhanced k-means clustering
#res.hclust = reactive({
#  eclust(my.data[,c("PeakTime","PastingTemp")], "hclust", k = input$k)
#  })


```

# Introduction

##

**Welcome to the Rice Processing Program Dashboard**

Rice is a staple food for over half of the world's population, with Asia being
its primary consumer base. As global demand continues to rise due to population
growth and changing dietary patterns, optimizing rice production and quality has
become essential. The state of Arkansas, known for its rich rice heritage, is a
leading producer of rice in the United States. Understanding the variation in
milling efficiency and physicochemical attributes among Arkansas rice cultivars
is crucial for enhancing the competitiveness of the state's rice sector and
meeting consumer preferences.

Our research aims to comprehensively assess the variation among Arkansas rice
cultivars concerning milling efficiency and physicochemical attributes,
including amylose content, gelatinization temperature, and grain dimensions. By
analyzing a diverse range of cultivars under controlled conditions, we seek to
elucidate the genetic and environmental factors contributing to differences in
rice quality.

This dashboard provides an interactive platform for exploring the data collected
from our research study. Through various visualizations and metrics, you can:

* Explore the variation in milling efficiency and physicochemical attributes
among different Arkansas rice cultivars
* Identify similarities and differences between cultivars based on their milling
yield and physicochemical attributes
* Access detailed information about individual cultivars, including their
genetic and environmental characteristics

By leveraging this dashboard, we hope to provide valuable insights into the
factors influencing rice quality and inform breeding programs aimed at
developing cultivars with superior milling and physicochemical characteristics.
We also aim to contribute to the global understanding of rice quality and its
determinants.

##

**Explore the Data**

Use the navigation menu on the left to access different sections of the
dashboard, including:

* Cultivar Comparison: Compare the milling efficiency and physicochemical
attributes of different cultivars
* Attribute Analysis: Explore detailed information about individual attributes,
such as amylose content and gelatinization temperature
* Correlation Analysis: Identify relationships between different attributes and
factors influencing rice quality

We hope this interactive platform will facilitate a deeper understanding of the
complexities involved in rice production and quality, ultimately benefiting rice
breeders, producers, and consumers alike.

# Cultivars

Distribution of a rice quality parameter by the type of cultivar.

```{r}
#| context: server

output$BoxplotType <- renderPlot({
  
  if (input$variable %in% time_variables){
    my.plot = ggplot(dataset(), aes(y = .data[[input$variable]], x = Time, color = Cultivar, group = Cultivar)) + stat_summary(geom = "line", fun = mean) + stat_summary(geom = "point", fun = mean)
  } else {
      CultivarData = rice.data %>% select("Cultivar")
      CultivarDataset = dataset() %>% mutate(CultivarData)
      my.plot = ggplot(CultivarDataset, aes(y = Cultivar, x = .data[[input$variable]])) + geom_boxplot(color = uarpp_colors[3], fill = uarpp_colors[1], alpha=0.7) 
      my.plot = my.plot + ylab(as.character(input$variable))
  }
  
  my.plot = my.plot + plot.theme
  print(my.plot)
})
```

```{r}
#| title: Distribution by Type
plotOutput("BoxplotType")
```


# Clustering

```{r}
#| context: server

output$ClusterAnalysis <- renderPlot({
  res.hclust <- eclust(pasting.data[,-1], "hclust", k = input$k)
  fviz_dend(res.hclust, rect = TRUE) + plot.theme # dendrogam
})
```

```{r}
#| title: Clustering by pasting properties
plotOutput("ClusterAnalysis")
```

# Pasting Properties

Clustering of cultivars by their *average* performance in terms of the **peak**, **trough**, **breakdown**, **setback**, and **final** viscosities. 

```{r}
#| context: server

output$PCA <- renderPlot({
  res.km <- eclust(pasting.data[,-1], "kmeans", nstart = 25, k = input$k) 
  res.km + plot.theme 
})
```

```{r}
#| title: Data vsualization
plotOutput("PCA")
```

# Labels

These are the numeric labels used for the cluster analysis of cultivars.

```{r}
#| context: server

output$TableLabels <- renderTable({
  label_df <- data.frame(
  "Label" = 1:nrow(pasting.data[,1]),
  "Cultivar" = pasting.data[,1])
  
})
```

```{r}
#| title: Cultivar labels
tableOutput("TableLabels")
```