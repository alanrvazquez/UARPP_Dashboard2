---
title: "RPP Dashboard"
author: ""
logo: "images/UARPP-LogoV2.png"
format: 
  dashboard:
    orientation: rows
    theme: custom.scss
server: shiny
---

```{r}
#| context: setup
#| echo: false
#| output: false

#install.packages("zoo")
# Load libraries.
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggformula)
library(factoextra) # For cluster analysis
library(zoo) # For Area Under the Curve (AUC)
library(DT)

################################################################################
# Read data
################################################################################
rice.data = read_excel("data/cultivar_data_2019-2023_May6.xlsx")

################################################################################
# Preprocessing
################################################################################

rice.data = rice.data %>%  mutate_at(c("Year", "Cultivar", "Pureline Hybrid", "Grain Size"), as.factor)

select_variables = tbl_vars(rice.data)[c(6:13, 64:68)]
subset_rice.data = rice.data %>% select(all_of(select_variables))

nontime_vars = c("Field Fissures", "Windseedle Brown Rice Chalkiness", "Peak Viscosity", "Trough Viscosity", "Breakdown Viscosity", "Setback Viscosity", "Final Viscosity")
time_variables = c("Milled Rice Yield", "Head Rice Yield")

# Data for pasting properties
pasting.data = rice.data %>% select(c("Cultivar", "Peak Viscosity", "Trough Viscosity", "Breakdown Viscosity", "Setback Viscosity", "Final Viscosity")) %>% 
  group_by(Cultivar) %>% 
  summarise_all(mean, na.rm = TRUE)

# Data for HRY, MRY, Field Fissures, and WBrown_Chalk only.
varis.for.auc = c("Milled Rice Yield", "Head Rice Yield")
recorded.time <- c(10, 15, 20, 30, 40)

AUC <- function(x, z){
  sum(diff(z)*rollmean(x,2))
}
AUC_variables <- matrix(NA, ncol = length(varis.for.auc), nrow = nrow(rice.data))
citer <- 1
for(variable in varis.for.auc){
  aux.data <- rice.data %>% select(starts_with(variable))
  AUC_variables[,citer] <- apply(aux.data, MARGIN = 1, FUN = AUC, z = recorded.time)
  citer <- citer + 1
}
HRY.data = rice.data %>% select("Cultivar", "Field Fissures", "Windseedle Brown Rice Chalkiness")
HRY.data = HRY.data %>%  add_column("Milled Rice Yield" = AUC_variables[,1], "Head Rice Yield" = AUC_variables[,1]) %>% 
  group_by(Cultivar) %>% 
  summarise_all(mean, na.rm = TRUE)
# Replace missing entries with the mean
HRY.data = HRY.data %>% mutate(across(-1, ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

# Generate all data.
all.data = left_join(HRY.data, pasting.data, by = "Cultivar")
var_names = colnames(all.data)[-1]

################################################################################
# Plot theme
################################################################################

ytext <- 18
xtext <- ytext
y.axis.title <- 20
x.axis.title <- y.axis.title
legtext <- 18

uarpp_colors <- c("#D9516D", "#C49A6C", "#000000")

plot.theme <- theme_minimal() +
  theme(
    text = element_text(family = "Georgia", color = "#000000"),  # Font and text color
    panel.background = element_rect(fill = "#ffffff"),  # Background color
    plot.background = element_rect(fill = "#ffffff"),
    legend.background = element_rect(fill = "#ffffff"),
    legend.position = "top",
    axis.title = element_text(size = 20, color = "#A0192E", face = "bold"),  # Red axis labels
    axis.text = element_text(size = 18, color = "#000000"),  # Black axis text
    legend.text = element_text(size = 18, color = "#000000"),
    legend.title = element_text(size = 20, color = "#A0192E", face = "bold")
  )
```


# {.sidebar}

```{r}
#| title: Inputs
#selectInput("sampleSize", "Number of subjects:", 
#            unique(summary_results$n))
#radioButtons("year", "Year:", 
#            c("All", "2019", "2020", "2021", "2022", "2023"))

#varSelectInput("variable", "Quality Parameter:", subset_rice.data)
selectInput("variable", "Rice Parameter:", var_names)
sliderInput("k", "Groups:", min = 2, max = 5, value = 3)
```

```{r}
#| context: server
#| echo: false
#| output: false

dataset = reactive({
    if (input$variable %in% time_variables){
        my.data = rice.data %>% select(starts_with(input$variable))
        my.data = my.data %>% rename_with(~str_remove(., paste(input$variable, '_', sep = '')))
        my.data = my.data %>% rename_with(~str_remove(., 's'))
        var_sel = my.data %>%  colnames()
        my.data = my.data %>% mutate("Cultivar" = rice.data$Cultivar)
        my.data = my.data %>% pivot_longer(cols = all_of(var_sel), names_to = "Time", values_to = input$variable)
        my.data = my.data %>% mutate_at("Time", as.numeric)  
    } else {
      my.data = subset_rice.data %>% select(input$variable)    
    }
    
  my.data
})

# Enhanced k-means clustering
#res.hclust = reactive({
#  eclust(my.data[,c("PeakTime","PastingTemp")], "hclust", k = input$k)
#  })


```

# Introduction

## Welcome

**Welcome to the Rice Processing Program Dashboard**

The mission of the Arkansas Rice Processing Program is to conduct both basic and applied research aimed at improving the efficiency of current processing operations and generating foundational knowledge for the development of new rice products and processes. Ultimately, the program seeks to enhance the quality and value of rice and rice-based products. A key focus is understanding the variation in physicochemical attributes that influence milling performance and help Arkansas rice cultivars better meet market and consumer demands.
 
Our research focuses on a comprehensive assessment of the physicochemical variation among Arkansas rice cultivars, with particular emphasis on traits that influence milling performance and functionality in product development. We examine a broad set of characteristics, including grain dimensions, milling yield, pasting properties, amylose content, gelatinization temperature, and hydration behavior, among others.

This interactive dashboard showcases the data collected over a five-year study, during which all rice cultivars were grown under uniform soil and environmental conditions. It offers dynamic visualizations that reveal how various rice quality metrics have changed over time. 
 
Our goal is to support breeding programs in developing cultivars with enhanced milling and functional traits, and to assist processors and product developers in selecting the most suitable cultivars for specific end-use applications in rice-based products.


## Explore the data

**Explore the Data**

Use the navigation menu on the left to explore various sections of the dashboard, including:

- Cultivar Comparison: Compare milling performance and physicochemical traits across different rice cultivars
- Attribute Analysis: Dive into detailed data on individual quality attributes, such as amylose content and gelatinization temperature
- Correlation Analysis: Discover relationships between attributes and identify key factors influencing rice quality

We hope this interactive platform enhances understanding of the complex factors driving rice processing and qualityâ€”ultimately supporting breeders, producers, processors, and consumers in making informed decisions.

## Version

**Version**: The dashboard has data from cultivars in the years of 2019 to 2023. 

# Cultivars

Distribution of a rice parameter by the type of cultivar.

```{r}
#| context: server

output$BoxplotType <- renderPlot({
  
  if (input$variable %in% time_variables){
    my.plot = ggplot(dataset(), aes(y = .data[[input$variable]], x = Time, color = Cultivar, group = Cultivar)) + stat_summary(geom = "line", fun = mean) + stat_summary(geom = "point", fun = mean)
  } else {
      CultivarData = rice.data %>% select("Cultivar")
      CultivarDataset = dataset() %>% mutate(CultivarData)
      my.plot = ggplot(CultivarDataset, aes(y = Cultivar, x = .data[[input$variable]])) + geom_boxplot(color = uarpp_colors[3], fill = uarpp_colors[1], alpha=0.7) 
      my.plot = my.plot 
  }
  
  my.plot = my.plot + plot.theme
  print(my.plot)
})
```

```{r}
#| title: Distribution by Cultivar
plotOutput("BoxplotType")
```

# All Parameters

## Description

Clustering of cultivars by their *average* performance in terms of the **head rice yield (HRY)**, **mild rice yield (MRY)**, **field fissures**, **brown chalk**, and **peak**, **trough**, **breakdown**, **setback**, and **final** viscosities. The HRY and MRY are further summarized using their area under the curve.

## Clustering

```{r}
#| context: server

output$ClusterAnalysisALL <- renderPlot({
  res.hclust <- eclust(all.data[,-1], "hclust", k = input$k, stand = TRUE)
  fviz_dend(res.hclust, rect = TRUE) + plot.theme # dendrogam
})
```

```{r}
#| title: Hierarchical Clustering
plotOutput("ClusterAnalysisALL")
```

```{r}
#| context: server

output$PCAALL <- renderPlot({
  res.km <- eclust(all.data[,-1], "kmeans", nstart = 25, k = input$k, stand = TRUE) 
  fviz_cluster(res.km) + plot.theme 
})
```

```{r}
#| title: K-means clustering with dimension reduction
plotOutput("PCAALL")
```


# Selected Parameters

## Description

Clustering of cultivars by their *average* performance in terms of the **head rice yield (HRY)**, **mild rice yield (MRY)**, **field fissures**, and **brown chalk** only. The HRY and MRY are further summarized using their area under the curve.

## Clustering

```{r}
#| context: server

output$ClusterAnalysisHRY <- renderPlot({
  res.hclust <- eclust(HRY.data[,-1], "hclust", k = input$k, stand = TRUE)
  fviz_dend(res.hclust, rect = TRUE) + plot.theme # dendrogam
})
```

```{r}
#| title: Hierarchical Clustering
plotOutput("ClusterAnalysisHRY")
```

```{r}
#| context: server

output$PCAHRY <- renderPlot({
  res.km <- eclust(HRY.data[,-1], "kmeans", nstart = 25, k = input$k, stand = TRUE) 
  fviz_cluster(res.km) + plot.theme 
})
```

```{r}
#| title: K-means clustering with dimension reduction
plotOutput("PCAHRY")
```

# Pasting Properties

## Description

Clustering of cultivars by their *average* performance in terms of the **peak**, **trough**, **breakdown**, **setback**, and **final** viscosities only. 

## Clustering

```{r}
#| context: server

output$ClusterAnalysis <- renderPlot({
  res.hclust <- eclust(pasting.data[,-1], "hclust", k = input$k, stand = TRUE)
  fviz_dend(res.hclust, rect = TRUE) + plot.theme # dendrogam
})
```

```{r}
#| title: Hierarchical Clustering
plotOutput("ClusterAnalysis")
```


```{r}
#| context: server

output$PCA <- renderPlot({
  res.km <- eclust(pasting.data[,-1], "kmeans", nstart = 25, k = input$k, stand = TRUE) 
  fviz_cluster(res.km) + plot.theme
})
```

```{r}
#| title: K-means clustering with dimension reduction
plotOutput("PCA")
```

# Labels

These are the numeric labels used for the cluster analysis of cultivars.

```{r}
#| context: server

output$TableLabels <- renderDataTable({
  label_df <- data.frame(
  "Label" = 1:nrow(pasting.data[,1]),
  "Cultivar" = pasting.data[,1])
  
  datatable(label_df)
})
```

```{r}
#| title: Cultivar labels
dataTableOutput("TableLabels")
```